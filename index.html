<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <div>
        <label id="myid">myid is: </label>

    </div>
    <div>
        <label>peer id is: </label>
        <input type="text" id="peerid">
        <button onclick="connectToPeer()">connect</button>
        <button onclick="sendhw()">hello w</button>
    </div>
    <canvas id="sgame" width="800" height="600" style="background-color:aliceblue;border: solid black">
    </canvas>

    <script>
        var gamer = prompt('your game nick name pls');
        var enemies = [];
       
        //init game
        var canvas = document.getElementById('sgame');
        var ctx = canvas.getContext('2d');

        var socket = io('http://172.17.184.13:8877');
        socket.on('SNAKE_MOVE', function (data) {
            var enemyObject;
            var enemySnake;
            enemies.forEach(function (enemy) {
                if (enemy.gamer == data.gamer) {
                    enemy.snake.forEach(function (item) {
                        ctx.clearRect(item.x, item.y, snakeSize, snakeSize);
                    });
                    enemyObject = enemy;
                    enemy.snake=JSON.parse(data.snake);
                    enemySnake = enemy.snake;
                }
            });

            if (!enemyObject) { //cant find
                enemyObject = { gamer: data.gamer, snake: JSON.parse(data.snake) };
                enemies.push(enemyObject);
                enemySnake=enemyObject.snake;
            }

            console.log(data);


            
            for (var i = 0; i < enemySnake.length; i++) {
                var item = enemySnake[i];
                ctx.fillStyle = 'green';
                if (i == enemySnake.length - 1) {
                    ctx.fillStyle = 'red';
                }
                ctx.fillRect(item.x, item.y, snakeSize, snakeSize);

            }
        });
        var snake = [{
            x: 10,
            y: 10
        }, {
            x: 35,
            y: 10
        }, {
            x: 60,
            y: 10
        }, {
            x: 85,
            y: 10
        }, {
            x: 110,
            y: 10
        }];

        var snakeSize = 25;
        var direction = 'right';






        document.addEventListener("keydown", function (event) {
            console.log(event.keyCode);
            switch (event.keyCode) {
                case 37:
                    //left
                    direction = 'left';
                    break;
                case 38:
                    //up
                    direction = 'up';
                    break;
                case 39:
                    //right
                    direction = 'right';
                    break;
                case 40:
                    //down
                    direction = 'down';
                    break;

                default:
                    break;
            }
        });

        //game loop
        function gameLoop() {
            var head = snake[snake.length - 1];
            var tail = snake[0];
            var newHead = {
                x: 0,
                y: 0
            };

            switch (direction) {
                case 'right':
                    newHead.x = head.x + snakeSize;
                    newHead.y = head.y;
                    break;
                case 'down':
                    newHead.x = head.x;
                    newHead.y = head.y + snakeSize;

                    break;
                case 'left':
                    newHead.x = head.x - snakeSize;
                    newHead.y = head.y;

                    break;
                case 'up':
                    newHead.x = head.x;
                    newHead.y = head.y - snakeSize;
                    break;

                default:
                    break;
            }

            ctx.clearRect(tail.x, tail.y, snakeSize, snakeSize);
            snake.splice(0, 1);
            snake.push(newHead);
            drawSnake(ctx);
            socket.emit('SNAKE_MOVE', { gamer: gamer, snake: JSON.stringify(snake) });



        }

        function drawSnake(ctx) {

            for (var i = 0; i < snake.length; i++) {
                var item = snake[i];
                ctx.fillStyle = 'green';
                if (i == snake.length - 1) {
                    ctx.fillStyle = 'red';
                }
                ctx.fillRect(item.x, item.y, snakeSize, snakeSize);

            }


        }
        setInterval(gameLoop, 500);
        //alert('xeii');
    </script>

</body>

</html>